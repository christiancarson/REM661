---
title: "Ricker and Larkin Models - Assignment 4"
output: github_document
author: "Christian Carson"
date: "03/05/2024"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
Read in the data and set up the procedure section. 
Data can be read from github at: https://github.com/christiancarson/REM661/blob/main/Assingment%204/Sockeye.data

```{r}
data <- read.table("https://raw.githubusercontent.com/christiancarson/REM661/main/Assingment%204/Sockeye.data", header=TRUE, sep="\t")
stocks    <- unique( data$Stock )
nstock    <- length( stocks )
```

#\ln\left(\frac{R_t}{S_t}\right)=\alpha-\beta S_t+\omega_t

The Ricker model is written as:
$$\ln\left(\frac{R_t}{S_t}\right)=\alpha-\beta S_t+\omega_t$$

where:
- $R_t$ is the number of recruits in year $t$
- $S_t$ is the number of spawners in year $t$
- $\alpha$ is the intercept
- $\beta$ is the slope
- $\omega_t$ is the error term

Here we will fit a linear model to estimate alpha and beta in log( R/S ) = alpha - beta * S

```{r Ricker}
"Ricker" <- function(){
  
  # create a list to fill with outputs from each stock
  rick <- list()    
  
  # loop over stocks
  for( i in 1:nstock ){
    # identify parts of data file that corresponds to this stock
    stock.id   <- data$Stock == stocks[i]
    # separate out stock-specific recruits and spawners
    R          <- data$Recruits[ stock.id ]
    S          <- data$Spawners[ stock.id ]
    rick[[i]]   <- lm( log( R/S ) ~ S )   # linear regression on transformed Ricker model
    rick[[i]]$r <- exp( rick[[i]]$fitted.values ) * S # back-transform to original Ricker model
    stockname <- stocks[i]
  }
  
  # return findings so they are preserved outside the function
  return( rick )
    return( stockname )
    results <- data.frame(Stock=stockname, alpha=alpha, beta=beta)
}
```

Next, we will create a function to estimate parameters and fitted values based on the Larkin model. The Larkin model is written as:
$$\ln\left(\frac{R_t}{S_t}\right)=\alpha-\beta_0S_t-\beta_1S_{t-1}-\beta_2S_{t-2}-\beta_3S_{t-3}+\omega_t$$

where:
- $R_t$ is the number of recruits in year $t$
- $S_t$ is the number of spawners in year $t$
- $\alpha$ is the intercept
- $\beta_0$ is the slope for the current year
- $\beta_1$ is the slope for the previous year
- $\beta_2$ is the slope for the year before the previous year
- $\beta_3$ is the slope for the year before the year before the previous year
- $\omega_t$ is the error term

```{r}
"Larkin" <- function(){
  # Fit linear model to estimate alpha and beta in log( R/S ) = alpha - beta * S
  # create a list to fill with outputs from each stock
  lark <- list()    
  for( i in 1:nstock ){
    stock.id   <- data$Stock == stocks[i]
    R          <- data$Recruits[ stock.id ]
    S          <- data$Spawners[ stock.id ]
    nyr       <- length( R ) 
    #all recruits except first three years
    Rt        <- R[ 4:nyr ]
    #all spawners except for first three years
    St        <- S[ 4:nyr ]
    #Spanwers 1 year before current year
   Sm1 <- S[ 3: (nyr-1) ]
    #Spanwers 2 years before current year
    Sm2 <- S[ 2: (nyr-2) ]
    #Spanwers 3 years before current year
    Sm3 <- S[ 1: (nyr-3) ]
    lark[[i]] <- glm( log( Rt/St ) ~ St + Sm1 + Sm2 + Sm3)
    lark[[i]]$r <- exp( lark[[i]]$fitted.values ) * St
    alpha <- coef(lark[[i]])[1]
    beta0 <- coef(lark[[i]])[2]
    stockname <- stocks[i]
  }
  return( lark )
  return( alpha )
    return( beta0 )
    return( stockname )
 results <- data.frame(Stock=stockname, alpha=alpha, beta0=beta0)   
}
```
fit1 <- Ricker()
fit2 <- Larkin()


Now we will create a multi-figure plot of the stock-recruitment relationship for the 10 stocks using a loop for each of the 10 stocks. We will need to estimate the 
α and β parameters using the Ricker, plot the observed data, then estimate the coefficents from Larkin for each using glm() and .

Add the predicted values from the Larkin model to the stock-recruitment plots.
Refining the Plot: Adjusting the aesthetic properties of your plot (labels, title, scales, etc.) to ensure they are clear and informative.



